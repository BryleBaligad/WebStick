<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>WebStick</title>
    <script src="joy.js"></script>
    <style>
        * {
            touch-action: none;
            color: white;
            user-select: none !important;
            -webkit-touch-callout: none;
            -webkit-user-callout: none;
            -webkit-user-select: none;
            -webkit-user-drag: none;
            -webkit-user-modify: none;
            -webkit-highlight: none;
            font-family: Arial, Helvetica, sans-serif;
        }

        div {
            touch-action: none;
            user-select: none !important;
            -webkit-user-select: none !important;
        }

        body {
            margin: 0;
            background-color: black;
            overflow: hidden;
            position: fixed;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none !important;
        }

        .shoulder {
            background-color: red;
            width: 175px;
            height: 60px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none !important;
            transition: transform 0.5s ease, height 0.5s ease;
        }

        /* .shoulder:active {
            background-color: darkred;
        } */

        .faceButton {
            background-color: blue;
            width: 70px;
            height: 70px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none !important;
            border-radius: 100px;
            display: grid;
            place-items: center;
        }

        .faceButton.mono {
            font-family: monospace;
            font-size: x-large;
        }

        button {
            color: black
        }

        button.fullWidth {
            width: 100%;
        }

        button.spaceBottom {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div id="settingsMenuContainer" style="display: none; place-items: center; width: 100vw; height: 100vh;">
        <div style="background-color: #ffffff55; padding: 2px 32px 32px 32px; border-radius: 8px; z-index: 10; width: 200px;">
            <center>
                <h3>Settings</h3>
            </center>
            <button class="fullWidth spaceBottom" id="reload">Reload</button><br>
            <button class="fullWidth spaceBottom" id="toggleTriggers">Toggle Triggers</button><br>
            <button class="fullWidth spaceBottom" id="reconnect">Reconnect</button><br>
            <button class="fullWidth spaceBottom" id="switchButtonLayout">Switch Button Layout</button><br>
            <button class="fullWidth spaceBottom" id="closeSettings">Close</button><br>
        </div>
    </div>
    <div style="position: fixed; width: 100vw; top: 20px; left: 0; scale: 1.3">
        <center>
            <button id="settings">Settings</button>
        </center>
    </div>
    <div style="position: fixed; top: 0; left: 0; z-index: 3;">
        <div id="triggerL" class="shoulder">L2</div>
        <div id="shoulderL" class="shoulder" style="border-bottom-right-radius: 50px;">L1</div>
    </div>
    <div style="position: fixed; top: 0; right: 0; z-index: 3;">
        <div id="triggerR" class="shoulder" style="text-align: right;">R2</div>
        <div id="shoulderR" class="shoulder" style="border-bottom-left-radius: 50px; text-align: right;">R1</div>
    </div>
    <center>
        <div style="position: fixed; width: 100vw; top: 25%; z-index: 2;">
            <center>
                <div id="back" class="faceButton" style="display: inline-grid">Back</div>
                &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
                <div id="start" class="faceButton" style="display: inline-grid">Start</div>
            </center>
        </div>
    </center>
    <div style="position: fixed; bottom: 20px; left: 0">
        <center>
            <div id="hatN" class="faceButton mono" style="touch-action: none; transform: translateY(10px)">▲</div>
            <div id="hatW" class="faceButton mono" style="display: inline-grid; touch-action: none;">◀</div> &nbsp; &nbsp; &nbsp; &nbsp; <div id="hatE" class="faceButton mono" style="display: inline-grid; touch-action: none;">▶</div>
            <div id="hatS" class="faceButton mono" style="touch-action: none; transform: translateY(-10px)">▼</div>
        </center>
    </div>
    <div style="position: fixed; bottom: 20px; right: 0">
        <center>
            <div id="faceTop" action="X" class="faceButton mono" style="touch-action: none; transform: translateY(10px)">X</div>
            <div id="faceLeft" action="Y" class="faceButton mono" style="display: inline-grid; touch-action: none;">Y</div> &nbsp; &nbsp; &nbsp; &nbsp; <div id="faceRight" action="A" class="faceButton mono" style="display: inline-grid; touch-action: none;">A</div>
            <div id="faceBottom" action="B" class="faceButton mono" style="touch-action: none; transform: translateY(-10px)">B</div>
        </center>
    </div>
    <div style="position: fixed; bottom: 0; left: 170px">
        <div id="leftStick" style="width:150px;height:150px;margin-bottom:20px;"></div>
    </div>
    <div style="position: fixed; bottom: 0; right: 170px">
        <div id="rightStick" style="width:150px;height:150px;margin-bottom:20px;"></div>
    </div>
    <script>
        if (window.matchMedia("(orientation: portrait)").matches) {
            window.alert("Please rotate to landscape mode")
        }

        var serverLocation = `ws://${document.location.hostname}:8779`
        var ws = new WebSocket(serverLocation)

        ws.onmessage = (message) => {
            switch (message) {
                case "ZERO SLOTS":
                    window.alert("Out of slots on server")
                    break;
            }
        }

        var reconnecting = false;
        ws.onclose = () => {
            if (!reconnecting) window.alert("Disconnected from server!")
        }

        function showHideSettingsMenu(show) {
            if (show) {
                document.getElementById("settingsMenuContainer").style.display = "grid"
            } else {
                document.getElementById("settingsMenuContainer").style.display = "none"
            }
        }

        var triggersEnabled = true
        function toggleTriggers() {
            if (triggersEnabled) {
                document.getElementById("triggerL").style.transform = "translateY(-60px)"
                document.getElementById("triggerR").style.transform = "translateY(-60px)"

                document.getElementById("shoulderL").style.transform = "translateY(-60px)"
                document.getElementById("shoulderR").style.transform = "translateY(-60px)"
                document.getElementById("shoulderL").style.height = "80px"
                document.getElementById("shoulderR").style.height = "80px"
                triggersEnabled = false
            } else {
                document.getElementById("triggerL").style.transform = ""
                document.getElementById("triggerR").style.transform = ""

                document.getElementById("shoulderL").style.transform = ""
                document.getElementById("shoulderR").style.transform = ""
                document.getElementById("shoulderL").style.height = ""
                document.getElementById("shoulderR").style.height = ""
                triggersEnabled = true
            }
        }

        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        document.ondblclick = function(e) {
            e.preventDefault();
        }

        document.getElementById("reload").addEventListener("touchend", evt => {
            evt.preventDefault();
            window.location.reload()
        })

        document.getElementById("toggleTriggers").addEventListener("touchend", evt => {
            evt.preventDefault();
            toggleTriggers()
        })

        document.getElementById("reconnect").addEventListener("touchend", evt => {
            evt.preventDefault();
            var response = prompt("Reconnect to server", serverLocation)
            reconnecting = true
            serverLocation = response
            ws.close()
            ws = null
            ws = new WebSocket(serverLocation)
            ws.onopen = () => {
                reconnecting = false
            }
        })

        document.getElementById("settings").addEventListener("touchend", evt => {
            evt.preventDefault();
            showHideSettingsMenu(true)
        })

        document.getElementById("closeSettings").addEventListener("touchend", evt => {
            evt.preventDefault();
            showHideSettingsMenu(false)
        })

        var layoutMode = localStorage.getItem("WebStick-LayoutMode") || "NINTENDO"
        if (!localStorage.getItem("WebStick-LayoutMode")) localStorage.setItem("WebStick-LayoutMode", layoutMode)
        setLayoutMode(layoutMode)
        document.getElementById("switchButtonLayout").addEventListener("touchend", evt => {
            evt.preventDefault();
            cycleLayoutMode()
        })

        function cycleLayoutMode() {
            if (layoutMode == "NINTENDO") {
                layoutMode = "XBOX"
                setLayoutMode(layoutMode)
                localStorage.setItem("WebStick-LayoutMode", layoutMode)
                return;
            }

            if (layoutMode == "XBOX") {
                layoutMode = "PLAYSTATION"
                setLayoutMode(layoutMode)
                localStorage.setItem("WebStick-LayoutMode", layoutMode)
                return;
            }

            if (layoutMode == "PLAYSTATION") {
                layoutMode = "NINTENDO"
                setLayoutMode(layoutMode)
                localStorage.setItem("WebStick-LayoutMode", layoutMode)
                return;
            }
        }

        function setLayoutMode(mode) {
            switch(mode) {
                case "NINTENDO":
                    document.getElementById("back").innerText = "-"
                    document.getElementById("start").innerText = "+"
                    document.getElementById("faceTop").innerText = "X"
                    document.getElementById("faceTop").setAttribute("action", "X")
                    document.getElementById("faceTop").className = "faceButton"
                    document.getElementById("faceBottom").innerText = "B"
                    document.getElementById("faceBottom").setAttribute("action", "B")
                    document.getElementById("faceBottom").className = "faceButton"
                    document.getElementById("faceLeft").innerText = "Y"
                    document.getElementById("faceLeft").setAttribute("action", "Y")
                    document.getElementById("faceLeft").className = "faceButton"
                    document.getElementById("faceRight").innerText = "A"
                    document.getElementById("faceRight").setAttribute("action", "A")
                    document.getElementById("faceRight").className = "faceButton"
                    break;

                case "XBOX":
                    document.getElementById("back").innerText = "Back"
                    document.getElementById("start").innerText = "Start"
                    document.getElementById("faceTop").innerText = "Y"
                    document.getElementById("faceTop").setAttribute("action", "Y")
                    document.getElementById("faceTop").className = "faceButton"
                    document.getElementById("faceBottom").innerText = "A"
                    document.getElementById("faceBottom").setAttribute("action", "A")
                    document.getElementById("faceBottom").className = "faceButton"
                    document.getElementById("faceLeft").innerText = "X"
                    document.getElementById("faceLeft").setAttribute("action", "X")
                    document.getElementById("faceLeft").className = "faceButton"
                    document.getElementById("faceRight").innerText = "B"
                    document.getElementById("faceRight").setAttribute("action", "B")
                    document.getElementById("faceRight").className = "faceButton"
                    break;

                case "PLAYSTATION":
                    document.getElementById("back").innerText = "Share"
                    document.getElementById("start").innerText = "Menu"
                    document.getElementById("faceTop").innerText = "△"
                    document.getElementById("faceTop").setAttribute("action", "Y")
                    document.getElementById("faceTop").className = "faceButton mono"
                    document.getElementById("faceBottom").innerText = "⨉"
                    document.getElementById("faceBottom").setAttribute("action", "A")
                    document.getElementById("faceBottom").className = "faceButton mono"
                    document.getElementById("faceLeft").innerText = "□"
                    document.getElementById("faceLeft").setAttribute("action", "X")
                    document.getElementById("faceLeft").className = "faceButton mono"
                    document.getElementById("faceRight").innerText = "◯"
                    document.getElementById("faceRight").setAttribute("action", "B")
                    document.getElementById("faceRight").className = "faceButton mono"
                    break;
            }
        }

        var leftOptions = {
            zone: document.getElementById('leftStick'),
            mode: 'static',
            position: {
                top: '75px',
                left: '75px'
            }
        };
        var leftManager = nipplejs.create(leftOptions);

        leftManager.on("move", (evt, nipple) => {
            var x = nipple.instance.frontPosition.x / leftOptions.zone.offsetWidth * 3;
            var y = nipple.instance.frontPosition.y / leftOptions.zone.offsetHeight * 3;

            x = Math.max(-1, Math.min(1, x));
            y = Math.max(-1, Math.min(1, y));

            ws.send(`LEFT STICK ${x} ${y*-1}`)
        })

        leftManager.on("end", () => {
            ws.send(`LEFT STICK 0 0`)
        })

        var rightOptions = {
            zone: document.getElementById('rightStick'),
            mode: 'static',
            position: {
                top: '75px',
                left: '75px'
            }
        };
        var rightManager = nipplejs.create(rightOptions);
        rightManager.on("move", (evt, nipple) => {
            var x = nipple.instance.frontPosition.x / rightOptions.zone.offsetWidth * 3;
            var y = nipple.instance.frontPosition.y / rightOptions.zone.offsetHeight * 3;

            x = Math.max(-1, Math.min(1, x));
            y = Math.max(-1, Math.min(1, y));

            ws.send(`RIGHT STICK ${x} ${y*-1}`)
        })

        rightManager.on("end", () => {
            ws.send(`RIGHT STICK 0 0`)
        })

        setInterval(() => {
            ws.send("PING!")
        }, 5000);

        document.body.addEventListener('touchstart', (evt) => {
            evt.preventDefault()
        })

        document.body.addEventListener('touchend', (evt) => {
            evt.preventDefault()
        })

        document.getElementById("faceRight").addEventListener('touchstart', (evt) => {
            document.getElementById("faceRight").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceRight").getAttribute("action")} DOWN`)
        })

        document.getElementById("faceRight").addEventListener('touchend', (evt) => {
            document.getElementById("faceRight").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceRight").getAttribute("action")} UP`)
        })

        document.getElementById("faceBottom").addEventListener('touchstart', (evt) => {
            document.getElementById("faceBottom").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceBottom").getAttribute("action")} DOWN`)
        })

        document.getElementById("faceBottom").addEventListener('touchend', (evt) => {
            document.getElementById("faceBottom").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceBottom").getAttribute("action")} UP`)
        })

        document.getElementById("faceTop").addEventListener('touchstart', (evt) => {
            document.getElementById("faceTop").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceTop").getAttribute("action")} DOWN`)
        })

        document.getElementById("faceTop").addEventListener('touchend', (evt) => {
            document.getElementById("faceTop").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceTop").getAttribute("action")} UP`)
        })

        document.getElementById("faceLeft").addEventListener('touchstart', (evt) => {
            document.getElementById("faceLeft").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceLeft").getAttribute("action")} DOWN`)
        })

        document.getElementById("faceLeft").addEventListener('touchend', (evt) => {
            document.getElementById("faceLeft").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send(`${document.getElementById("faceLeft").getAttribute("action")} UP`)
        })

        document.getElementById("hatN").addEventListener('touchstart', (evt) => {
            document.getElementById("hatN").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send("HAT N DOWN")
        })

        document.getElementById("hatN").addEventListener('touchend', (evt) => {
            document.getElementById("hatN").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send("HAT N UP")
        })

        document.getElementById("hatS").addEventListener('touchstart', (evt) => {
            document.getElementById("hatS").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send("HAT S DOWN")
        })

        document.getElementById("hatS").addEventListener('touchend', (evt) => {
            document.getElementById("hatS").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send("HAT S UP")
        })

        document.getElementById("hatW").addEventListener('touchstart', (evt) => {
            document.getElementById("hatW").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send("HAT W DOWN")
        })

        document.getElementById("hatW").addEventListener('touchend', (evt) => {
            document.getElementById("hatW").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send("HAT W UP")
        })

        document.getElementById("hatE").addEventListener('touchstart', (evt) => {
            document.getElementById("hatE").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send("HAT E DOWN")
        })

        document.getElementById("hatE").addEventListener('touchend', (evt) => {
            document.getElementById("hatE").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send("HAT E UP")
        })

        document.getElementById("back").addEventListener('touchstart', (evt) => {
            document.getElementById("back").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send("BACK DOWN")
        })

        document.getElementById("back").addEventListener('touchend', (evt) => {
            document.getElementById("back").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send("BACK UP")
        })

        document.getElementById("start").addEventListener('touchstart', (evt) => {
            document.getElementById("start").style.backgroundColor = "darkblue"
            evt.preventDefault()
            ws.send("START DOWN")
        })

        document.getElementById("start").addEventListener('touchend', (evt) => {
            document.getElementById("start").style.backgroundColor = "blue"
            evt.preventDefault()
            ws.send("START UP")
        })

        document.getElementById("shoulderL").addEventListener('touchstart', (evt) => {
            document.getElementById("shoulderL").style.backgroundColor = "darkred"
            evt.preventDefault()
            ws.send("SHOULDER L DOWN")
        })

        document.getElementById("shoulderL").addEventListener('touchend', (evt) => {
            document.getElementById("shoulderL").style.backgroundColor = "red"
            evt.preventDefault()
            ws.send("SHOULDER L UP")
        })

        document.getElementById("shoulderR").addEventListener('touchstart', (evt) => {
            document.getElementById("shoulderR").style.backgroundColor = "darkred"
            evt.preventDefault()
            ws.send("SHOULDER R DOWN")
        })

        document.getElementById("shoulderR").addEventListener('touchend', (evt) => {
            document.getElementById("shoulderR").style.backgroundColor = "red"
            evt.preventDefault()
            ws.send("SHOULDER R UP")
        })

        document.getElementById("triggerL").addEventListener('touchstart', (evt) => {
            document.getElementById("triggerL").style.backgroundColor = "darkred"
            evt.preventDefault()
            ws.send("TRIGGER L DOWN")
        })

        document.getElementById("triggerL").addEventListener('touchend', (evt) => {
            document.getElementById("triggerL").style.backgroundColor = "red"
            evt.preventDefault()
            ws.send("TRIGGER L UP")
        })

        document.getElementById("triggerR").addEventListener('touchstart', (evt) => {
            document.getElementById("triggerR").style.backgroundColor = "darkred"
            evt.preventDefault()
            ws.send("TRIGGER R DOWN")
        })

        document.getElementById("triggerR").addEventListener('touchend', (evt) => {
            document.getElementById("triggerR").style.backgroundColor = "red"
            evt.preventDefault()
            ws.send("TRIGGER R UP")
        })
    </script>
</body>
</html>